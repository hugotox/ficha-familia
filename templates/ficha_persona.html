{% extends 'base.html' %}
{% load common_tags %}

{% block title %}
    Ficha: {{ persona }}
{% endblock %}

{% if not es_admin %}
    {% block extra_brand %}
        - Centro Familiar {{ centro_familiar }}
    {% endblock %}
{% endif %}

{% block content %}

    <h1>Parte II: Evaluación de Factores Protectores</h1>

    {% if message %}
        <div class="alert alert-{{ message_class }}">
            {{ message }}
        </div>
    {% endif %}

    <br>

    <form action="" method="post" class="form-horizontal form-evaluacion">{% csrf_token %}
        {{ form.persona }}
        {{ form.anio_aplicacion }}

        <div class="control-group">
            <label class="control-label">
                Ficha de Desarrollo N°:
            </label>
            <div class="controls" style="padding-top: 5px">
                <b></b>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">
                Familia:
            </label>
            <div class="controls" style="padding-top: 5px">
                <b>{{ persona.familia }} ({{ persona.familia.id|zfill:10 }})</b>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">
                Persona:
            </label>
            <div class="controls" style="padding-top: 5px">
                <b>{{ persona }}</b>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">
                Año de aplicación:
            </label>
            <div class="controls" style="padding-top: 5px">
                <b>{{ anio }}</b>
            </div>
        </div>

        <fieldset>
            <legend>A. Relaciones Comunitarias</legend>
        </fieldset>

        {% include 'tabla_evaluacion_a.html' %}

        <fieldset>
            <legend>B. Acceso</legend>
        </fieldset>

        {% include 'tabla_evaluacion_b.html' %}

        <fieldset>
            <legend>C. Vínculos Familiares</legend>
        </fieldset>

        {% include 'tabla_evaluacion_c.html' %}

        <fieldset>
            <legend>D. Derechos Infantiles</legend>
        </fieldset>

        {% include 'tabla_evaluacion_d.html' %}

        <fieldset>
            <legend>E. Desarrollo Personal</legend>
        </fieldset>

        {% include 'tabla_evaluacion_e.html' %}

        <br>

        <div class="form-actions">
            <button type="submit" value="Guardar" class="btn btn-primary">
                Guardar
            </button>

            <a href="{{ back_url }}" class="pull-right">
                Volver
            </a>

        </div>

    </form>

{% endblock %}

{% block extra_footer %}
<script type="text/javascript">

    function promediar($fila, etapa){
        var $table = $fila.closest('table');
        var suma = 0;
        var num_elementos = 0;
        var $radios = $table.find("input[type='radio']." + etapa);
        for(var i=0; i<$radios.length; i++){
            var $r = $($radios[i]);
            if($r.is(':checked')){
                var valor = parseInt($r.val());
                if(valor != -100){
                    suma += valor;
                    num_elementos++;
                }
            }
        }
        if(num_elementos > 0){
            var promedio = round_number(suma / num_elementos, 2);
            $table.find(".prom-" + etapa).html(promedio);
        } else {
            $table.find(".prom-" + etapa).html("");
        }
    }

    $(document).ready(function () {

        $('.fila-evaluacion').each(function(){

            var $fila = $(this);

            $fila.find("input[type='radio'].ini").change(function(){
                var valor = $(this).val();
                promediar($fila, 'ini');
            });

            $fila.find("input[type='radio'].cum").change(function(){
                var valor = $(this).val();
                promediar($fila, 'cum');
            });

            $fila.find(".link-limpiar-ini").click(function(){
                $fila.find("input[type='radio'].ini").each(function(){
                    $(this).attr("checked", false);
                });
                promediar($fila, 'ini');
                return false;
            });

            $fila.find(".link-limpiar-cum").click(function(){
                $fila.find("input[type='radio'].cum").each(function(){
                    $(this).attr("checked", false);
                });
                promediar($fila, 'cum');
                return false;
            });

            promediar($fila, 'ini');
            promediar($fila, 'cum');

        });

    });
</script>
{% endblock %}