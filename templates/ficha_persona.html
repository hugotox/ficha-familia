{% extends 'base.html' %}
{% load common_tags %}

{% block title %}
    Ficha: {{ persona }}
{% endblock %}

{% if not es_admin %}
    {% block extra_brand %}
        - Centro Familiar {{ centro_familiar }}
    {% endblock %}
{% endif %}

{% block content %}

    <form action="" method="post" class="form-horizontal form-evaluacion">{% csrf_token %}

        <ul class="nav nav-tabs">
            <li class="active"><a href="#parte2" data-toggle="tab">Parte II: Evaluaci√≥n de Factores Protectores</a></li>
            <li><a href="#parte3" data-toggle="tab">Parte III: Plan de Desarrollo</a></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane active" id="parte2">
                {% include 'ficha_parte2.html' %}
            </div>
            <div class="tab-pane" id="parte3">
                {% include 'ficha_parte3.html' %}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" value="Guardar" class="btn btn-primary">
                Guardar
            </button>

            {% if evaluacion %}
                <a href="/ficha/{{ persona.id }}/{{ evaluacion.anio_aplicacion }}/del/?{{ str_filters }}" class="btn">
                    Eliminar Ficha
                </a>
            {% endif %}

            <a href="{{ back_url }}" class="pull-right">
                Volver
            </a>

        </div>

    </form>

{% endblock %}

{% block extra_footer %}
<script type="text/javascript">

    function promediar($fila, etapa){
        var $table = $fila.closest('table');
        var suma = 0;
        var num_elementos = 0;
        var $radios = $table.find("input[type='radio']." + etapa);
        for(var i=0; i<$radios.length; i++){
            var $r = $($radios[i]);
            if($r.is(':checked')){
                var valor = parseInt($r.val());
                if(valor != -100){
                    suma += valor;
                    num_elementos++;
                }
            }
        }
        if(num_elementos > 0){
            var promedio = round_number(suma / num_elementos, 2);
            $table.find(".prom-" + etapa).html(promedio);
        } else {
            $table.find(".prom-" + etapa).html("");
        }
    }

    $(document).ready(function () {

        $('.fila-evaluacion').each(function(){

            var $fila = $(this);

            $fila.find("input[type='radio'].ini").change(function(){
                var valor = $(this).val();
                promediar($fila, 'ini');
            });

            $fila.find("input[type='radio'].cum").change(function(){
                var valor = $(this).val();
                promediar($fila, 'cum');
            });

            $fila.find(".link-limpiar-ini").click(function(){
                $fila.find("input[type='radio'].ini").each(function(){
                    $(this).attr("checked", false);
                });
                promediar($fila, 'ini');
                return false;
            });

            $fila.find(".link-limpiar-cum").click(function(){
                $fila.find("input[type='radio'].cum").each(function(){
                    $(this).attr("checked", false);
                });
                promediar($fila, 'cum');
                return false;
            });

            promediar($fila, 'ini');
            promediar($fila, 'cum');

        });

    });
</script>
{% endblock %}